<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Print Report ‚Äî Business Records Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <style>
        /* ===== SCREEN STYLES ===== */
        :root {
            --bg: #0a0e17;
            --surface: #111827;
            --surface2: #1a2235;
            --border: #2a3347;
            --accent: #3b82f6;
            --green: #34d399;
            --yellow: #fbbf24;
            --red: #f87171;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --dim: #475569;
            --radius: 10px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: #374255;
            border-radius: 3px;
        }

        /* CONTROLS BAR */
        .controls {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(17, 24, 39, .95);
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(16px);
            display: flex;
            flex-wrap: wrap;
            gap: .55rem;
            align-items: center;
            padding: .75rem 1.3rem;
        }

        .controls .logo {
            font-size: .95rem;
            font-weight: 800;
            color: #60a5fa;
            margin-right: .5rem;
        }

        .ctrl {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text);
            padding: .42rem .75rem;
            font-size: .78rem;
            font-family: inherit;
            outline: none;
            transition: border-color .15s;
        }

        .ctrl:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .12);
        }

        .ctrl::placeholder {
            color: var(--dim);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: .3rem;
            padding: .45rem .9rem;
            border-radius: 7px;
            font-size: .78rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: inherit;
            transition: all .18s;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }

        .btn-primary:hover {
            box-shadow: 0 0 18px rgba(59, 130, 246, .5);
            transform: translateY(-1px);
        }

        .btn-ghost {
            background: transparent;
            color: var(--muted);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--surface2);
            color: var(--text);
        }

        /* SUMMARY STRIP */
        .summary-strip {
            display: flex;
            gap: .6rem;
            padding: .75rem 1.3rem;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            flex-wrap: wrap;
        }

        .sum-card {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: .45rem .9rem;
        }

        .sum-card .sl {
            font-size: .62rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .04em;
        }

        .sum-card .sv {
            font-weight: 700;
            font-size: .92rem;
            margin-top: 1px;
            color: #60a5fa;
        }

        /* REPORT AREA */
        .report-wrap {
            padding: 1.2rem 1.3rem;
        }

        .report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .report-header h2 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
        }

        .report-header span {
            font-size: .72rem;
            color: var(--muted);
        }

        /* TABLE */
        .print-table {
            width: 100%;
            border-collapse: collapse;
            font-size: .77rem;
        }

        .print-table thead th {
            background: var(--surface2);
            color: var(--muted);
            padding: .55rem .7rem;
            text-align: left;
            font-size: .63rem;
            text-transform: uppercase;
            letter-spacing: .05em;
            font-weight: 700;
            border-bottom: 2px solid var(--accent);
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        .print-table thead th.r {
            text-align: right;
        }

        .print-table thead th.c {
            text-align: center;
        }

        .print-table tbody tr {
            transition: background .12s;
        }

        .print-table tbody tr:hover td {
            background: rgba(59, 130, 246, .05);
        }

        .print-table tbody tr:nth-child(even) td {
            background: rgba(26, 34, 53, .5);
        }

        .print-table tbody td {
            padding: .48rem .7rem;
            border-bottom: 1px solid rgba(42, 51, 71, .5);
            white-space: nowrap;
        }

        .print-table tbody td.r {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .print-table tbody td.c {
            text-align: center;
        }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: .15rem .45rem;
            border-radius: 20px;
            font-size: .62rem;
            font-weight: 700;
        }

        .b-clear {
            background: rgba(52, 211, 153, .12);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, .25);
        }

        .b-pend30 {
            background: rgba(251, 191, 36, .12);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, .25);
        }

        .b-pend {
            background: rgba(248, 113, 113, .12);
            color: #f87171;
            border: 1px solid rgba(248, 113, 113, .25);
        }

        .print-table tfoot td {
            background: var(--surface2);
            font-weight: 700;
            padding: .55rem .7rem;
            border-top: 2px solid var(--accent);
            font-size: .77rem;
        }

        .print-table tfoot td.r {
            text-align: right;
            color: #60a5fa;
        }

        .empty-row td {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            body {
                background: #fff !important;
                color: #000 !important;
                font-size: 9pt;
            }

            .controls,
            .summary-strip {
                display: none !important;
            }

            .report-wrap {
                padding: 0 !important;
            }

            .report-header {
                margin-bottom: .4cm;
            }

            .report-header h2 {
                color: #000 !important;
                font-size: 11pt;
            }

            .report-header span {
                color: #555 !important;
            }

            .print-table {
                border-collapse: collapse;
            }

            .print-table thead th {
                background: #1a4b8a !important;
                color: #fff !important;
                border: 1px solid #1a4b8a !important;
                font-size: 7.5pt;
                padding: 4px 6px !important;
                position: static !important;
            }

            .print-table tbody tr:nth-child(even) td {
                background: #f5f7fa !important;
            }

            .print-table tbody tr:hover td {
                background: inherit !important;
            }

            .print-table tbody td {
                background: #fff;
                color: #000 !important;
                border: 1px solid #d0d5dd !important;
                padding: 4px 6px !important;
                font-size: 8pt;
            }

            .print-table tfoot td {
                background: #e8eff8 !important;
                color: #000 !important;
                border: 1px solid #aac !important;
                font-size: 8pt;
                padding: 4px 6px !important;
            }

            .print-table tfoot td.r {
                color: #1a4b8a !important;
            }

            .badge {
                border: 1px solid #ccc !important;
            }

            .b-clear {
                background: #d4edda !important;
                color: #155724 !important;
            }

            .b-pend30 {
                background: #fff3cd !important;
                color: #856404 !important;
            }

            .b-pend {
                background: #f8d7da !important;
                color: #721c24 !important;
            }
        }

        @page {
            margin: 1.2cm;
            size: A4 landscape;
        }
    </style>
</head>

<body>

    <!-- CONTROLS -->
    <div class="controls">
        <span class="logo">üñ® Print Report</span>
        <input class="ctrl" type="text" id="fMiller" placeholder="Filter Miller Name" />
        <input class="ctrl" type="text" id="fShop" placeholder="Filter Shop Name" />
        <select class="ctrl" id="fStatus" style="min-width:130px">
            <option value="">All Statuses</option>
            <option value="cleared">Cleared</option>
            <option value="pending">Pending</option>
        </select>
        <input class="ctrl" type="date" id="fFrom" title="From Date" />
        <input class="ctrl" type="date" id="fTo" title="To Date" />
        <button class="btn btn-ghost" onclick="applyFilters()">üîç Apply</button>
        <button class="btn btn-ghost" onclick="resetFilters()">‚úï Reset</button>
        <button class="btn btn-primary" onclick="window.print()">üñ® Print / Save PDF</button>
        <a href="index.html" class="btn btn-ghost">‚Üê Back</a>
    </div>

    <!-- SUMMARY -->
    <div class="summary-strip" id="summaryStrip"></div>

    <!-- REPORT -->
    <div class="report-wrap">
        <div class="report-header">
            <h2 id="reportTitle">Business Records Report</h2>
            <span id="reportDate"></span>
        </div>
        <table class="print-table">
            <thead>
                <tr>
                    <th class="c">#</th>
                    <th>Date</th>
                    <th>Shop Name</th>
                    <th>Miller Name</th>
                    <th>No of Days</th>
                    <th>L.H.</th>
                    <th>Bill No</th>
                    <th class="r">QTY</th>
                    <th class="r">Rate (‚Çπ)</th>
                    <th class="r">Amount (‚Çπ)</th>
                </tr>
            </thead>
            <tbody id="printBody">
                <tr class="empty-row">
                    <td colspan="10">Loading...</td>
                </tr>
            </tbody>
            <tfoot id="printFoot"></tfoot>
        </table>
    </div>

    <script type="module">
        import { initFirebase, onAuthStateChanged, recordsCol, onSnapshot, query, orderBy } from './firebase.js';

        let allRecords = [];

        const fmtN = n => { const v = parseFloat(n); return isNaN(v) ? '‚Äî' : v.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };

        function daysBadge(r) {
            if (r.paymentDate) return `<span class="badge b-clear">‚úì Cleared</span>`;
            const d = parseInt(r.noOfDays) || 0;
            const txt = r.noOfDays || 'PENDING';
            return d > 30
                ? `<span class="badge b-pend">${txt}</span>`
                : `<span class="badge b-pend30">${txt}</span>`;
        }

        function getFiltered() {
            const miller = document.getElementById('fMiller').value.trim().toLowerCase();
            const shop = document.getElementById('fShop').value.trim().toLowerCase();
            const status = document.getElementById('fStatus').value;
            const from = document.getElementById('fFrom').value;
            const to = document.getElementById('fTo').value;
            return allRecords.filter(r => {
                if (miller && !(r.millerName || '').toLowerCase().includes(miller)) return false;
                if (shop && !(r.shopName || '').toLowerCase().includes(shop)) return false;
                if (status === 'cleared' && !r.paymentDate) return false;
                if (status === 'pending' && r.paymentDate) return false;
                if (from && r.date < from) return false;
                if (to && r.date > to) return false;
                return true;
            }).sort((a, b) => (a.date || '').localeCompare(b.date || ''));
        }

        window.applyFilters = function () { render(getFiltered()); };
        window.resetFilters = function () {
            ['fMiller', 'fShop'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('fStatus').value = '';
            document.getElementById('fFrom').value = '';
            document.getElementById('fTo').value = '';
            render(allRecords);
        };

        function render(list) {
            const totAmt = list.reduce((s, r) => s + (parseFloat(r.amount) || 0), 0);
            const totQty = list.reduce((s, r) => s + (parseFloat(r.qty) || 0), 0);
            const clrd = list.filter(r => r.paymentDate).length;
            const pend = list.length - clrd;

            document.getElementById('summaryStrip').innerHTML = [
                ['Records', list.length, '#60a5fa'],
                ['Cleared', clrd, '#34d399'],
                ['Pending', pend, '#f87171'],
                ['Total QTY', totQty.toLocaleString('en-IN', { maximumFractionDigits: 2 }), '#60a5fa'],
                ['Total Amount (‚Çπ)', '‚Çπ' + fmtN(totAmt), '#fbbf24'],
            ].map(([l, v, c]) => `<div class="sum-card"><div class="sl">${l}</div><div class="sv" style="color:${c}">${v}</div></div>`).join('');

            document.getElementById('reportTitle').textContent =
                `Business Records Report ‚Äî ${list.length} record${list.length !== 1 ? 's' : ''}`;
            document.getElementById('reportDate').textContent =
                'Generated: ' + new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

            const esc = s => (s || '‚Äî').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            if (!list.length) {
                document.getElementById('printBody').innerHTML =
                    `<tr class="empty-row"><td colspan="10">No records match the current filters.</td></tr>`;
                document.getElementById('printFoot').innerHTML = '';
                return;
            }

            document.getElementById('printBody').innerHTML = list.map((r, i) => `
      <tr>
        <td class="c" style="color:var(--dim);font-size:.7rem">${i + 1}</td>
        <td>${esc(r.date)}</td>
        <td style="font-weight:600">${esc(r.shopName)}</td>
        <td>${esc(r.millerName)}</td>
        <td>${daysBadge(r)}</td>
        <td>${esc(r.lr)}</td>
        <td>${esc(r.billNo)}</td>
        <td class="r">${fmtN(r.qty)}</td>
        <td class="r">${fmtN(r.rate)}</td>
        <td class="r" style="font-weight:700">${fmtN(r.amount)}</td>
      </tr>`).join('');

            document.getElementById('printFoot').innerHTML = `
      <tr>
        <td colspan="7" style="font-weight:700">TOTALS &nbsp;(${list.length} records)</td>
        <td class="r">${totQty.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
        <td></td>
        <td class="r">${fmtN(totAmt)}</td>
      </tr>`;
        }

        // trigger on Enter
        document.querySelectorAll('.ctrl').forEach(el => el.addEventListener('keydown', e => {
            if (e.key === 'Enter') window.applyFilters();
        }));

        // Boot: connect to Firestore
        (async () => {
            try {
                const { auth, db } = await initFirebase();
                if (!auth || !db) {
                    document.body.innerHTML = '<div style="padding: 2rem; text-align: center; color: red;">Firebase not configured. Please set up environment variables.</div>';
                    return;
                }
                onAuthStateChanged(auth, user => {
                    if (!user) { location.replace('./login.html'); return; }
                    onSnapshot(query(recordsCol(db, user.uid), orderBy('date', 'desc')), snap => {
                        allRecords = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        render(allRecords);
                    }, error => {
                        console.error('Firestore error:', error);
                        document.body.innerHTML = '<div style="padding: 2rem; text-align: center; color: red;">Error loading records. Please check Firestore configuration.</div>';
                    });
                });
            } catch (err) {
                console.error('Firebase initialization error:', err);
                document.body.innerHTML = '<div style="padding: 2rem; text-align: center; color: red;">Firebase initialization failed. Please refresh.</div>';
            }
        })();
    </script>
</body>

</html>